<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Hodimlar nazorati</title>

<style>
body{
    margin:0;
    font-family:Segoe 
        UI;background:#f3f5f7
}
.header{
    background:#2b5f98;
    color:#fff;
    padding:20px 40px;
    display:flex;
    align-items:center
}
.logo{
    width:55px;
    height:55px;
    margin-right:15px;
}

.title{
    font-size:28px;
    font-weight:bold
}

.container{
    width:85%;
    margin:40px auto
}
.card{
    border:3px solid #2b5f98;border-radius:15px;padding:25px;margin-bottom:25px;background:white;position:relative}
.name{font-size:24px;font-weight:bold;color:#2b5f98}
.btn{background:#2b5f98;color:white;border:none;padding:10px 20px;border-radius:10px;margin-top:15px;margin-right:10px;cursor:pointer}
.plus{position:absolute;right:25px;top:50%;transform:translateY(-50%);width:50px;height:50px;border-radius:50%;font-size:22px}
.section{display:none;margin-top:20px;border-top:1px solid #ddd;padding-top:10px}
.bottom{width:85%;margin:30px auto;display:flex;justify-content:space-between}
.green{background:#28a745}
.red{background:#dc3545}
</style>
</head>

<body>

<div class="header">
<img src="images/studentcall.png" class="logo">
<div class="title">Hodimlar nazorati</div>
</div>

<div class="container" id="staffContainer"></div>

<div class="bottom">
<button class="btn red" onclick="history.back()">Orqaga</button>
<button class="btn green" onclick="addStaff()">Hodim qo'shish +</button>
</div>

<script>

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyndSS2U8CPB43R3-7kNGbCoWOWasfIyb-otomiwm104tdlD7BdpjSiNGdsWvNMB0H3dA/exec";

let staff = [];

/* =========================
   GOOGLE SHEETGA YUBORISH
========================= */
function sendToSheet(data){
    fetch(SCRIPT_URL,{
        method:"POST",
        body:JSON.stringify(data),
        headers:{
            "Content-Type":"application/json"
        }
    })
    .then(()=>loadFromSheet()) // har safar yangilab oladi
    .catch(err=>console.log("Sheet error:",err));
}

/* =========================
   GOOGLE SHEETDAN O‘QISH
========================= */
function loadFromSheet(){
  fetch(SCRIPT_URL)
  .then(res=>res.json())
  .then(data=>{
      staff = data.staff.map(s=>{
          return {
              name:s[0],
              role:s[1],
              place:s[2],
              tasks:[]
          }
      });

      data.tasks.forEach(t=>{
          let person = staff.find(s=>s.name===t[0]);
          if(person){
              person.tasks.push({
                  name:t[1],
                  place:t[2],
                  date:t[3],
                  status:Number(t[4])
              });
          }
      });

      render();
  })
  .catch(err=>console.log("Load error:",err));
}

/* =========================
   RENDER
========================= */
function render(){
    staffContainer.innerHTML="";
    staff.forEach((s,i)=>{
        const card=document.createElement("div");
        card.className="card";

        card.innerHTML=`
        <div class="name">${s.name}</div>
        <div>Lavozimi: ${s.role}</div>
        <div>Ish joyi: ${s.place}</div>

        <button class="btn" onclick="toggle(this,0)">Vazifalari</button>
        <button class="btn" onclick="toggle(this,1)">Bajarilgan vazifalar</button>
        <button class="btn" onclick="toggle(this,2)">Muddati o'tgan vazifalar</button>
        <button class="btn plus" onclick="addTask(${i})">+</button>

        <div class="section">${tasksHTML(s.tasks,0,i)}</div>
        <div class="section">${tasksHTML(s.tasks,1,i)}</div>
        <div class="section">${tasksHTML(s.tasks,2,i)}</div>
        `;
        staffContainer.appendChild(card);
    });
}

/* =========================
   TASK HTML
========================= */
function tasksHTML(tasks,status,index){
    return tasks
    .filter(t=>t.status===status)
    .map((t,ti)=>{
        return `
        <p>
            ${t.name} | ${t.place} | ${t.date}
            ${status==0?`<button onclick="done(${index},'${t.name}')">Bajarildi</button>`:""}
        </p>`;
    }).join("");
}

/* =========================
   SECTION TOGGLE
========================= */
function toggle(btn,i){
    const sec=btn.parentElement.querySelectorAll(".section")[i];
    sec.style.display=sec.style.display==="block"?"none":"block";
}

/* =========================
   STAFF QO‘SHISH
========================= */
function addStaff(){
    const name=prompt("Ism familiya:");
    const role=prompt("Lavozimi:");
    const place=prompt("Ish joyi:");
    if(!name) return;

    sendToSheet({
        page:"staff_add",
        formData:{name,role,place}
    });
}

/* =========================
   VAZIFA QO‘SHISH
========================= */
function addTask(i){
    const name = prompt("Vazifa nomi:");
    const date = prompt("Muddat YYYY-MM-DD:");
    const place = prompt("Bajariladigan joyi:");
    if(!name) return;

    const now = new Date().toISOString().split("T")[0];
    let status = date < now ? 2 : 0;

    sendToSheet({
        page:"task_add",
        formData:{
            staff: staff[i].name,
            name,
            place,
            date,
            status
        }
    });
}

/* =========================
   BAJARILDI
========================= */
function done(i,taskName){
    sendToSheet({
        page:"task_done",
        formData:{
            staff: staff[i].name,
            task: taskName
        }
    });
}

/* =========================
   SAHIFA OCHILGANDA
========================= */
loadFromSheet();

</script>
</body>
</html>





