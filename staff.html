<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Hodimlar nazorati</title>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#f3f5f7;
}
.header{
    background:#2b5f98;
    color:#fff;
    padding:20px 40px;
    display:flex;
    align-items:center;
}
.logo{
    width:55px;
    height:55px;
    margin-right:15px;
}
.title{
    font-size:28px;
    font-weight:bold;
}
.container{
    width:85%;
    margin:40px auto;
}
.card{
    border:3px solid #2b5f98;
    border-radius:15px;
    padding:25px;
    margin-bottom:25px;
    background:white;
    position:relative;
}
.name{font-size:24px;font-weight:bold;color:#2b5f98;}
.btn{
    background:#2b5f98;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:10px;
    margin-top:15px;
    margin-right:10px;
    cursor:pointer;
}
.plus{
    position:absolute;
    right:25px;
    top:50%;
    transform:translateY(-50%);
    width:50px;
    height:50px;
    border-radius:50%;
    font-size:22px;
}
.section{
    display:none;
    margin-top:20px;
    border-top:1px solid #ddd;
    padding-top:10px;
}
.bottom{
    width:85%;
    margin:30px auto;
    display:flex;
    justify-content:space-between;
}
.green{background:#28a745;}
.red{background:#dc3545;}
</style>
</head>

<body>

<div class="header">
<img src="images/studentcall.png" class="logo" alt="logo">
<div class="title">Hodimlar nazorati</div>
</div>

<div class="container" id="staffContainer"></div>

<div class="bottom">
<button class="btn red" onclick="history.back()">Orqaga</button>
<button class="btn green" onclick="addStaff()">Hodim qo'shish +</button>
</div>

<script>
/* =========================
   GOOGLE SHEETS API
   (Code.gs: staff + tasks)
========================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwyKz5n5w4WTbGeRXPUwY5JHsoWLNDyAonWIWVOIiNHYT6qZ0JHIeIK4M4-F9FwoSUZ/exec"; // <-- shu yerga web app link

let staff = []; // UI uchun

/* =========================
   API helpers
========================= */
async function apiList(){
  const res = await fetch(`${SCRIPT_URL}?action=list`, { cache:"no-store" });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error || "API list error");
  return j.data || [];
}

async function apiUpsertStaff(staffObj){
  const res = await fetch(SCRIPT_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"upsertStaff", staff: staffObj })
  });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error || "API upsertStaff error");
  return j.data; // {staff_id}
}

async function apiUpsertTask(taskObj){
  const res = await fetch(SCRIPT_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"upsertTask", task: taskObj })
  });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error || "API upsertTask error");
  return j.data; // {task_id}
}

async function apiMarkDone(task_id){
  const res = await fetch(SCRIPT_URL, {
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify({ action:"markDone", task_id })
  });
  const j = await res.json();
  if(!j.ok) throw new Error(j.error || "API markDone error");
  return j.data;
}

/* =========================
   UI load
========================= */
async function loadFromSheet(){
  try{
    staff = await apiList();

    // normalize
    staff = (staff || []).map(s=>({
      staff_id: s.staff_id || "",
      name: s.name || "",
      role: s.role || "",
      place: s.place || "",
      tasks: Array.isArray(s.tasks) ? s.tasks.map(t=>({
        id: t.id || t.task_id || "",
        name: t.name || t.task_name || "",
        place: t.place || t.task_place || "",
        date: t.date || t.task_date || "",
        status: Number(t.status ?? t.task_status ?? 0)
      })) : []
    }));

    render();
  }catch(err){
    console.log(err);
    alert("Sheetdan yuklashda xatolik! Deploy: Anyone / Execute as: Me ekanini tekshiring.");
    staff = [];
    render();
  }
}

/* =========================
   TASK statusini hisoblash
========================= */
function computeStatus(dateStr){
  const now = new Date().toISOString().split("T")[0];
  if(dateStr && dateStr < now) return 2; // muddati o'tgan
  return 0; // aktiv
}

/* =========================
   RENDER HTML
   (strukturani o'zgartirmadik)
========================= */
function render(){
  const staffContainer = document.getElementById("staffContainer");
  staffContainer.innerHTML = "";

  staff.forEach((s,i) => {
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="name">${escapeHtml(s.name || "")}</div>
      <div>Lavozimi: ${escapeHtml(s.role || "")}</div>
      <div>Ish joyi: ${escapeHtml(s.place || "")}</div>

      <button class="btn" onclick="toggle(this,0)">Vazifalari</button>
      <button class="btn" onclick="toggle(this,1)">Bajarilgan vazifalar</button>
      <button class="btn" onclick="toggle(this,2)">Muddati o'tgan vazifalar</button>
      <button class="btn plus" onclick="addTask(${i})">+</button>

      <div class="section">${tasksHTML(s.tasks || [],0,i)}</div>
      <div class="section">${tasksHTML(s.tasks || [],1,i)}</div>
      <div class="section">${tasksHTML(s.tasks || [],2,i)}</div>
    `;
    staffContainer.appendChild(card);
  });
}

/* =========================
   TASKS HTML generatsiyasi
========================= */
function tasksHTML(tasks, status, index){
  return (tasks || [])
    .filter(t => Number(t.status) === Number(status))
    .map(t => `
      <p>
        ${escapeHtml(t.name)} | ${escapeHtml(t.place || "")} | ${escapeHtml(t.date || "")}
        ${Number(status) === 0 ? `<button onclick="done(${index},'${encodeURIComponent(t.id)}')">Bajarildi</button>` : ""}
      </p>
    `)
    .join("");
}

/* =========================
   SECTION toggle funksiyasi
========================= */
function toggle(btn, i){
  const sec = btn.parentElement.querySelectorAll(".section")[i];
  sec.style.display = sec.style.display === "block" ? "none" : "block";
}

/* =========================
   Yangi hodim qo'shish (SHEET)
========================= */
async function addStaff(){
  const name = prompt("Ism familiya:");
  const role = prompt("Lavozimi:");
  const place = prompt("Ish joyi:");
  if(!name) return;

  try{
    await apiUpsertStaff({
      staff_id: "",             // bo'sh yuborsak backend yangi id beradi
      name: name.trim(),
      role: (role || "").trim(),
      place: (place || "").trim()
    });

    await loadFromSheet();
  }catch(err){
    console.log(err);
    alert("Hodim qo‘shishda xatolik: " + (err.message || err));
  }
}

/* =========================
   Yangi vazifa qo'shish (SHEET)
========================= */
async function addTask(i){
  const person = staff[i];
  if(!person || !person.staff_id){
    return alert("Hodim ID topilmadi. Avval hodimni qayta yuklang.");
  }

  const name = prompt("Vazifa nomi:");
  const date = prompt("Muddat YYYY-MM-DD:");
  const place = prompt("Bajariladigan joyi:");
  if(!name) return;

  const status = computeStatus((date || "").trim());

  try{
    await apiUpsertTask({
      task_id: "",                 // bo'sh yuborsak backend yangi id beradi
      staff_id: person.staff_id,   // ✅ qaysi hodimga tegishli
      name: name.trim(),
      place: (place || "").trim(),
      date: (date || "").trim(),
      status: status
    });

    await loadFromSheet();
  }catch(err){
    console.log(err);
    alert("Vazifa qo‘shishda xatolik: " + (err.message || err));
  }
}

/* =========================
   Vazifani bajarildi qilish (SHEET)
========================= */
async function done(i, taskIdEnc){
  const taskId = decodeURIComponent(taskIdEnc || "");
  if(!taskId) return;

  try{
    await apiMarkDone(taskId);
    await loadFromSheet();
  }catch(err){
    console.log(err);
    alert("Bajarildi qilishda xatolik: " + (err.message || err));
  }
}

/* =========================
   XSSdan himoya (matn)
========================= */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   START
========================= */
window.onload = loadFromSheet;
</script>
</body>
</html>









