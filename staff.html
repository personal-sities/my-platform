<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Hodimlar nazorati</title>

<style>
body{
    margin:0;
    font-family:Segoe UI;
    background:#f3f5f7;
}
.header{
    background:#2b5f98;
    color:#fff;
    padding:20px 40px;
    display:flex;
    align-items:center;
}
.logo{
    width:55px;
    height:55px;
    margin-right:15px;
}
.title{
    font-size:28px;
    font-weight:bold;
}
.container{
    width:85%;
    margin:40px auto;
}
.card{
    border:3px solid #2b5f98;
    border-radius:15px;
    padding:25px;
    margin-bottom:25px;
    background:white;
    position:relative;
}
.name{font-size:24px;font-weight:bold;color:#2b5f98;}
.btn{
    background:#2b5f98;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:10px;
    margin-top:15px;
    margin-right:10px;
    cursor:pointer;
}
.plus{
    position:absolute;
    right:25px;
    top:50%;
    transform:translateY(-50%);
    width:50px;
    height:50px;
    border-radius:50%;
    font-size:22px;
}
.section{
    display:none;
    margin-top:20px;
    border-top:1px solid #ddd;
    padding-top:10px;
}
.bottom{
    width:85%;
    margin:30px auto;
    display:flex;
    justify-content:space-between;
}
.green{background:#28a745;}
.red{background:#dc3545;}
</style>
</head>

<body>

<div class="header">
<img src="images/studentcall.png" class="logo" alt="logo">
<div class="title">Hodimlar nazorati</div>
</div>

<div class="container" id="staffContainer"></div>

<div class="bottom">
<button class="btn red" onclick="history.back()">Orqaga</button>
<button class="btn green" onclick="addStaff()">Hodim qo'shish +</button>
</div>

<script>

/* =========================
   LOCAL + REMOTE (READ-ONLY FOR OTHERS)
========================= */
const LS_KEY = "staff_app_data_v1";

// ADMIN token (o'zingizga)
const ADMIN_TOKEN = "12345"; 
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
// BUNI O'ZINGIZGA MAXFIY QILING!
// masalan: "diyorbek-2026"
// <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<

let staff = [];

/* =========================
   ADMIN tekshiruv
   - URL: staff.html?admin=12345
========================= */
function isAdmin(){
  const p = new URLSearchParams(location.search);
  return p.get("admin") === ADMIN_TOKEN;
}

/* =========================
   UI ni read-only qilish (admin emaslarga)
========================= */
function applyReadOnlyUI(){
  if(!isAdmin()){
    // pastdagi "Hodim qo'shish +" tugmasini yashiramiz
    const addBtn = document.querySelector(".bottom .green");
    if(addBtn) addBtn.style.display = "none";
  }
}

/* =========================
   LOCALSTORAGE ga saqlash (faqat admin)
========================= */
function saveToLocal(){
  if(!isAdmin()) return; // boshqalar saqlay olmaydi
  localStorage.setItem(LS_KEY, JSON.stringify(staff));
}

/* =========================
   LOCALSTORAGE dan o‘qish
========================= */
function loadFromLocal(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{ staff = JSON.parse(raw) || []; }
    catch(e){ console.log("Local parse error:", e); staff = []; }
  }else{
    staff = [];
  }
  render();
}

/* =========================
   REMOTE JSON dan o‘qish (hamma ko'radi)
   - data/staff.json
========================= */
async function loadFromRemoteOrLocal(){
  try{
    const res = await fetch("data/staff.json", { cache: "no-store" });
    if(!res.ok) throw new Error("remote not found");
    const remote = await res.json();

    // remote ma'lumotni hamma ko'rishi uchun staffga qo'yamiz
    staff = Array.isArray(remote) ? remote : [];

    // admin bo'lsa: localga ham yozib qo'yamiz (ixtiyoriy)
    if(isAdmin()){
      localStorage.setItem(LS_KEY, JSON.stringify(staff));
    }

    render();
  }catch(e){
    // remote ishlamasa localdan ko'rsatadi
    loadFromLocal();
  }
}

/* =========================
   RENDER HTML
========================= */
function render(){
  const staffContainer = document.getElementById("staffContainer");
  staffContainer.innerHTML = "";

  staff.forEach((s,i) => {
    const card = document.createElement("div");
    card.className = "card";

    // admin bo'lmasa: + tugma va "Bajarildi" tugmalari ko'rinmaydi
    const plusBtn = isAdmin()
      ? `<button class="btn plus" onclick="addTask(${i})">+</button>`
      : "";

    card.innerHTML = `
      <div class="name">${s.name || ""}</div>
      <div>Lavozimi: ${s.role || ""}</div>
      <div>Ish joyi: ${s.place || ""}</div>

      <button class="btn" onclick="toggle(this,0)">Vazifalari</button>
      <button class="btn" onclick="toggle(this,1)">Bajarilgan vazifalar</button>
      <button class="btn" onclick="toggle(this,2)">Muddati o'tgan vazifalar</button>

      ${plusBtn}

      <div class="section">${tasksHTML(s.tasks || [],0,i)}</div>
      <div class="section">${tasksHTML(s.tasks || [],1,i)}</div>
      <div class="section">${tasksHTML(s.tasks || [],2,i)}</div>
    `;
    staffContainer.appendChild(card);
  });

  applyReadOnlyUI();
}

/* =========================
   TASKS HTML
========================= */
function tasksHTML(tasks, status, index){
  return tasks
    .filter(t => Number(t.status) === Number(status))
    .map(t => `
      <p>
        ${t.name || ""} | ${t.place || ""} | ${t.date || ""}
        ${
          Number(status) === 0 && isAdmin()
            ? `<button onclick="done(${index},'${encodeURIComponent(t.name || "")}')">Bajarildi</button>`
            : ""
        }
      </p>
    `).join("");
}

/* =========================
   SECTION toggle
========================= */
function toggle(btn, i){
  const sec = btn.parentElement.querySelectorAll(".section")[i];
  sec.style.display = sec.style.display === "block" ? "none" : "block";
}

/* =========================
   ADD STAFF (faqat admin)
========================= */
function addStaff(){
  if(!isAdmin()) return alert("Sizda o‘zgartirish huquqi yo‘q (faqat ko‘rish).");

  const name = prompt("Ism familiya:");
  const role = prompt("Lavozimi:");
  const place = prompt("Ish joyi:");
  if(!name) return;

  staff.push({
    name,
    role: role || "",
    place: place || "",
    tasks: []
  });

  saveToLocal();
  render();
}

/* =========================
   ADD TASK (faqat admin)
========================= */
function addTask(i){
  if(!isAdmin()) return alert("Sizda o‘zgartirish huquqi yo‘q (faqat ko‘rish).");

  const name = prompt("Vazifa nomi:");
  const date = prompt("Muddat YYYY-MM-DD:");
  const place = prompt("Bajariladigan joyi:");
  if(!name) return;

  const now = new Date().toISOString().split("T")[0];
  let status = date < now ? 2 : 0;

  if(!staff[i].tasks) staff[i].tasks = [];
  staff[i].tasks.push({
    name,
    place: place || "",
    date: date || "",
    status
  });

  saveToLocal();
  render();
}

/* =========================
   DONE (faqat admin)
========================= */
function done(i, taskName){
  if(!isAdmin()) return alert("Sizda o‘zgartirish huquqi yo‘q (faqat ko‘rish).");

  const decoded = decodeURIComponent(taskName);
  const person = staff[i];
  if(!person || !person.tasks) return;

  const t = person.tasks.find(x => x.name === decoded && Number(x.status) === 0);
  if(t) t.status = 1;

  saveToLocal();
  render();
}

/* =========================
   START
========================= */

window.onload = loadFromRemoteOrLocal;
</script>
</body>
</html>






